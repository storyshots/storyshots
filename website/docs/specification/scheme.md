import { Diagram } from '@site/src/Diagram';

# Архитектура

`storyshots` является реализацией [спецификации](/specification/). Библиотека дополняет модель следующим:

* Браузер как честь детерминированной системы - тесты выполняются в браузере, в целевом окружении веб-приложений.
* Test-assisted программирование - тесты используются как окружение разработки в продвинутом UI-режиме.
* Закрытая архитектура - `storyshots` закрыт от деталей реализации приложений, что упрощает интеграцию решения.
* Расширяемость - ядро `storyshots` легко расширяется дополнительными инструментами и адаптерами приложений.

Рассмотрим архитектуру основных пакетов подробнее:

<Diagram src={require('./assets/scheme.drawio.png')} />

:::note
На диаграмме представлены все основные слои на которых располагаются лишь некоторые из существующих модулей. Полный
перечень приведён в [соответствующем разделе](/modules/).
:::

## AUT

AUT — это тестируемая часть приложения. Чем она больше, тем больше покрытие тестов и тем лучше они защищают от регресса.

### IExternals

Интерфейс взаимодействия с внешней средой, методы [чтения](/specification/requirements/query) и [записи](/specification/requirements/command) данных.

:::note
Чаще всего, на проектах данный интерфейс существует в неявном виде, то есть не объявлен в принципе.
:::

## Менеджер историй

Основной слой `storyshots`, состоит из единственного пакета `@storyshots/core`. В его ответственности входит:

- **Базовые примитивы** — описывает основные сущности проекта: истории, трансформации, конфигурации.
- **UI режим** — реализует UI режим управления историями
- **CI режим** — реализует фоновый режим запуска историй
- **Тестирование** — реализует всё что касается тестов: работа со слепками, обновления эталонов, обработки ошибок,
  определение пройденных сценариев.

:::note
Является полностью независимым от используемого на проекте стека за счёт интерфейсов `IPreviewClient` и
`IPreviewServer`.
:::

### IPreviewClient

Клиентская часть AUT, интегрирует менеджер историй с тестируемым приложением.

Ответственности:

* Описание основных тестовых сценариев.
* Отображение выбранной истории по заданным параметрам на экране.
* Интеграция состояния AUT и жизненного цикла теста: установка состояния и полный сброс.

:::note
Все перечисленные ответственности `IPreviewClient` выполняет с учётом реального стека тестируемого проекта:
- Упрощается интеграция `storyshots`.
- Повышается защита от регресса.
- Упрощается повторное использование компонентов системы.
:::

### IPreviewServer

Основная обязанность `IPreviewServer` - закрывать потребности `IPreviewClient` как FE-компонента системы. В основном это
обычная передача статики веб-приложения, однако, этим возможности могут не ограничиваться.

##### at

Хост веб-приложения, обычно это корневой адрес dev-сервера:

```ts
const server = {
  // По данному адресу развёрнут dev-сервер отдающий IPreviewClient
  at: 'http://localhost:3000',
  /* ... */
}
```

#### cleanup

Функция, вызывающаяся при закрытии сервера. Используется для освобождения занятых ресурсов.

```ts
const server = app.listen();

const config = {
  // Закрыть сервер при выходе из режима storyshots
  cleanup: () => server.close()
  /* ... */
}
```

## Клиенты AUT

Слой содержащий компоненты, адаптирующие AUT под интерфейс `IPreviewClient`.

:::tip
Пакет [`@storyshots/react`](/modules/react) адаптирует `react` приложения для менеджера `storyshots`.
:::

:::note
Для использования `storyshots` в, например, `vue` приложении, всё что нужно сделать так это реализовать интерфейс
`IPreviewClient`.
:::

## Серверы AUT

Слой содержит адаптеры сборщиков и серверов AUT на интерфейс `IPreviewServer`.

:::tip
[`@storyshots/exec-preview`](/modules/exec) — сервер preview использующий оригинальные скрипты сборки AUT.
:::

:::note
[`@storyshots/next`](/modules/next) является примером модуля который одновременно реализует как `IPreviewClient`, так и `IPreviewServer`.
:::

## Адаптеры внешней среды

Реализуют механизм подмены методов [чтения](/specification/requirements/query)
и [записи](/specification/requirements/command) данных внешнего окружения различными методами:

- `native` — это условное обозначение компонента. Описывает [один из способов](/patterns/replace#подмена-через-инверсию)
  самостоятельной подмены зависимостей.
- [`@storyshots/msw-externals`](/modules/msw) -
  реализует [не инвазивный метод](/patterns/replace#подмена-через-сайд-эффекты)
  подмены с помощью библиотеки `msw`.
